<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />
  <meta name="robots" content="noindex, nofollow" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ZhehanZ Protection</title>

  <!-- ===== 样式：沿用黑白灰主题 ===== -->
  <style>
    body{font-family:Arial,sans-serif;display:flex;flex-direction:column;justify-content:center;align-items:center;text-align:center;min-height:100vh;margin:0;padding:20px;background:#fff;color:#333}
    .spinner,.warning{width:40px;height:40px;margin-bottom:20px}
    .spinner{border:4px solid #ddd;border-top:4px solid #333;border-radius:50%;animation:spin 1s linear infinite}
    .warning{border:4px solid #333;border-radius:50%;display:none;position:relative}
    .warning::before{content:"!";color:#333;font-size:24px;font-weight:bold;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%)}
    @keyframes spin{to{transform:rotate(360deg)}}
    .large{font-size:1.8em;font-weight:bold;margin:0}
    .status{font-size:1em;color:#777;margin:8px 0 20px}
    .captcha-container{margin:20px 0}
    .captcha-container form{display:inline-block;text-align:left}
    .protection{font-size:.8em;color:#777;margin-top:20px;margin-bottom:5px}
    .more-info{display:flex;flex-direction:column;align-items:center}
    .more-info a{font-size:.8em;color:#777;text-decoration:underline;cursor:pointer;margin-bottom:5px}
    .info-text{font-size:.8em;color:#777;text-align:center;max-width:55%;overflow:hidden;max-height:0;opacity:0;transition:max-height .3s ease,opacity .3s ease}
    .info-text.open{max-height:200px;opacity:1}
    /* 视觉隐藏：不破坏脚本，仅隐藏显示 */
    .visually-hidden{opacity:0;height:1px;width:1px;overflow:hidden;pointer-events:none;position:relative}

    @media(prefers-color-scheme:dark){
      body{background:#121212;color:#e0e0e0}
      .spinner{border:4px solid #444;border-top:4px solid #e0e0e0}
      .warning{border-color:#e0e0e0}
      .warning::before{color:#e0e0e0}
      .status,.protection,.info-text,.more-info a{color:#aaa}
    }
  </style>
</head>

<body>
  <!-- 五秒模式图标 -->
  <div class="spinner"></div>
  <!-- Captcha 模式图标 -->
  <div class="warning"></div>

  <p class="large"  id="title"></p>
  <p class="status" id="status"></p>

  <!-- CAPTCHA 容器 – 插入 ::CAPTCHA_BOX:: -->
  <div class="captcha-container">
    <form id="captcha-form">
      ::CAPTCHA_BOX::
    </form>
  </div>

  <p class="protection" id="brand"></p>

  <!-- 详情/诊断信息 -->
  <div class="more-info">
    <a id="toggle"></a>
    <div class="info-text" id="detail"></div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- 语言文案 ---------- */
  const lang = navigator.language.startsWith('zh') ? 'zh' : 'en';
  const L = {
    zh:{
      five:{t:'请稍作等候',s1:'正在检查网络',s2:'检查完成，即将继续访问'},
      cap :{t:'请完成验证',s :'完成以下人机验证以继续访问'},
      brand:'ZhehanZ 由 Cloudflare 防护',
      show:'查看更多信息',hide:'隐藏更多信息',
      details:['::RAY_ID::','::CLIENT_IP:: ::GEO::','此页面因异常网络活动或强化的安全防护而显示。']
    },
    en:{
      five:{t:'A moment please',s1:'Checking your network...',s2:'Check complete. Proceeding...'},
      cap :{t:'Complete verification',s :'Pass the turnstile to continue access'},
      brand:'ZhehanZ protected by Cloudflare',
      show:'Show details',hide:'Hide details',
      details:['::RAY_ID::','::CLIENT_IP:: ::GEO::','This page appears due to unusual activity or enhanced security measures.']
    }
  }[lang];

  /* ---------- DOM 引用 ---------- */
  const spinner    = document.querySelector('.spinner');
  const warning    = document.querySelector('.warning');
  const titleEl    = document.getElementById('title');
  const statusEl   = document.getElementById('status');
  const brandEl    = document.getElementById('brand');
  const toggleEl   = document.getElementById('toggle');
  const detailEl   = document.getElementById('detail');
  const form       = document.getElementById('captcha-form');

  /* ---------- 公共文案 ---------- */
  brandEl.textContent  = L.brand;
  toggleEl.textContent = L.show;
  toggleEl.addEventListener('click',()=>{
    const open = detailEl.classList.toggle('open');
    toggleEl.textContent = open ? L.hide : L.show;
    if(open) detailEl.innerHTML = L.details.map(d=>`<p>${d}</p>`).join('');
  });

  /* ---------- 模式管理 ---------- */
  const widgetSel = '#turnstile-widget,#turnstile-wrapper,.cf-turnstile';
  const inputSel  = 'input[name="cf-turnstile-response"],input[name="cf_challenge_response"]';

  function findWidgetBox() {
    // 先查固定容器
    let box = form.querySelector(widgetSel);
    if (box) return box;
    // fallback: 找隐藏 input 再向上找包裹元素
    const input = form.querySelector(inputSel);
    return input ? input.closest('div[id],div[class]') || input.parentElement : null;
  }

  function visualHideExcept(box) {
    Array.from(form.children)
         .forEach(el => el.classList.toggle('visually-hidden', el !== box));
  }

  let mode  = 'init';      // 'five' or 'captcha'
  let timer = null;        // 5s 计时器句柄

  function toFive() {
    mode='five';
    warning.style.display = 'none';
    spinner.style.display = 'block';
    titleEl.textContent   = L.five.t;
    statusEl.textContent  = L.five.s1;
    timer = setTimeout(()=>{ if(mode==='five') statusEl.textContent=L.five.s2; }, 5000);
  }

  function toCaptcha(box) {
    mode='captcha';
    if (timer){ clearTimeout(timer); timer=null; }
    spinner.style.display = 'none';
    warning.style.display = 'block';
    titleEl.textContent   = L.cap.t;
    statusEl.textContent  = L.cap.s;
    visualHideExcept(box);           // 仅视觉隐藏非组件区
  }

  function evaluate() {
    const box = findWidgetBox();
    if (box && mode!=='captcha') return toCaptcha(box);
    if (!box && mode!=='five')   return toFive();
  }

  /* ---------- 监听表单 DOM 变化 ---------- */
  const observer = new MutationObserver(evaluate);
  observer.observe(form, { childList:true, subtree:true });

  /* ---------- 初始判断 ---------- */
  evaluate();
});
</script>
</body>
</html>